# Оглавление

- [Запуск](#запуск)
- [Объекты](#объекты)
- [Запросы](#запросы)
    - [Post](#post)
    - [Get](#get)
    - [Put](#put)
    - [Delete](#delete)
<br/><br/>

## Запуск
При страте api сервера задается режим работы: с файлом конфигурации и без. Для работы с файлом конфигурации при запуске указывается флаг “-c”.

В случае если флаг не был указана все необходимые настройки берутся из .env файла, а те настройки, которых нет в окружении выставляются в значение по умолчанию.

Файл конфигурации имеет следующие настройки
```
api_host: "0.0.0.0"
api_port: "8080"
db_host: "0.0.0.0"
db_port: "6534"
db_name: "testdb"
collection_name: "documents"
nesting_level: 2
cache_life_time_m: 15
cache_cleaning_interval_m: 10
```

Где
- api_host, api_port — адрес, по которому будет работать api
- db_host, db_port, db_name, collection_name — данные для подключения к reindexer (хост, порт, имя подключаемой базы данных и коллекция внутри бд соответственно)
- nesting_level — максимальный допустимый уровень вложенности документов
- cache_life_time_m, cache_cleaning_interval_m — время жизни кеша и интервал очистки.

Также в проекте лежит готовые решения для Docker. Как и запуск исключительно сервера в контейнере (Dockerfile), так и запуск одновременно двух контейнеров с севером и базой данных (Docker-compose). Для этих решений так же предполагается возможность использования конфига (аргумент ISCNF). Однако указывать это нужно на этапе сборки.
```
docker-compose build --build-arg ISCNF=-c
```
Решение для докера потребует предварительной компиляции
```
CGO_ENABLED=0 GOOS=linux go build -o main ./cmd/server/
```
<br/><br/>

## Объекты
Объектом базы данных является документ, обладающий следующей структурой:
```go
type Document struct {
    Id        int64
    ParentId  int64
    Depth     int
    Sort      int
    Body      string
    ChildList []int64
}
```

Поля Id, ParentId, Depth, ChildList, Sort являются системными, поле Body содержит непосредственно данные документа. Документ может содержать бесконечное количество несистемных полей.

Поля, доступные для изменения, прописываются в отдельной структуре:
```go
type AllowedField struct {
    Sort      int
    Body      string
    ChildList []int64
}
```

Для отображения полного документа используется следующая структура:
```go
type BigDocument struct {
    Id        int64
    Body      string
    ChildList []BigDocument
}
```
<br/><br/>
## Запросы

API реализует только http запросы. Доступными являются следующие методы: POST, GET, PUT, DELETE. Системные поля в запросах не могут быть изменены (за исключением `ChildList`). Лишние поля json не обрабатываются и ошибок не вызывают.
<br/><br/>

#### POST
Запрос осуществляется по пути /docs. В теле запроса может не быть информации, тогда будет создан новый пустой документ.
Пример тела запроса:
```
{
    "Body": "Body of new-created document",
    "UnprocessedField": "1000-7"
}
```
Здесь поле Body будет занесено в новый документ, а поле UnprocessedField - нет.
<br/><br/>

#### GET
Запрос осуществляется по путям: `/docs`, `/docs/:id`, `/big-docs`, `/big-docs/:id`. По первому пути выдаются все документы, по второму - можно получить документ с определенным id, по третьему и четвертому путям аналогичные действия только уже с большим документом.

Для получения списка документов предусмотрена пагинация со следующими параметрами:
- page — номер страницы,
- limit — количество документов, выводимых на одной странице.

Также при получении полного документа, вложенные документы первого уровня сортируются в обратном порядке по полю `sort`.
<br/><br/>

#### PUT
Запрос осуществляется по пути `/docs`. В теле запроса нужно указать Id и поля, которые необходимо обновить. Для обновления доступны поля `ChildList`, `Sort`, а также все несистемные. Ответ при обновлении будет либо ошибка, либо сообщение об успешном обновлении.
<br/><br/>

#### DELETE
Запрос осуществляется по пути `/docs/:id`. При удалении документа все дочерние документы также удаляются, при этом обновляется глубина у всех документов верхнего уровня.
